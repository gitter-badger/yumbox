(function(){var e,a;a=window.sys.modules.activities,e=function(e,n,t,i,r){var s;return s={assign:function(){return e.is_edit=n.current.name===a.states.edit.name,e.interests=sys.defaults.interests,e.daily_meal={main_dish:"",side_dishes:"",total:"",at:moment(),remained:""}},clear:function(){return jsonMask(e.daily_meal,"main_dish,side_dishes,total,at,remained/*,is_draft")},events:{assign:function(){return e.remove=s.events.remove,e.is_main=s.events.is_main,e.set_as_main=s.events.set_as_main,e.save=s.events.save},save:function(){return e.is_edit?s.events.update():s.events.create()},create:function(){return t.post(a.endpoints.create,s.clear(e.daily_meal)).success(function(e){return console.log(e),n.go("edit_daily_meal",{id:e.data.doc_key})}).error(function(a,n){return console.log(n),400===n?e.error=a.message.split("[")[1].slice(0,-1):void 0})},update:function(){var i;return i=a.endpoints.update.replace(":id",n.params.id),t.put(i,s.clear(e.daily_meal)).success(function(a){return e.daily_meal=a.data}).error(function(a,n){return 400===n?e.error=a.message.split("[")[1].slice(0,-1):void 0})},remove:function(r){var s,d;return d=a.endpoints.images.remove.replace(":id",n.params.id).replace(":name",e.daily_meal.images[r]),t["delete"](d).then(function(a){return e.daily_meal.images.splice(r,1)}),s=null,e.$watch("daily_meal.address",function(){return i.cancel(s),s=i(function(){return decode()},2e3)})},is_main:function(e){return null!==e.match(/main/)},set_as_main:function(i){var r;return r=a.endpoints.images.main.replace(":id",n.params.id).replace(":name",e.daily_meal.images[i]),t.post(r).then(function(a){return a.data.data=s.fix_cache(a.data.data),e.daily_meal.images=a.data.data})}},uploader:function(){var a;return a=e.uploader=new r({autoUpload:!0,alias:"images[0]"}),a.onSuccessItem=function(a,n,t,i){return n.data=s.fix_cache(n.data),e.daily_meal.images=n.data}},editing:function(){return e.uploader.url=a.endpoints.images.add.replace(":id",n.params.id),t.get(a.endpoints.get.replace(":id",n.params.id)).then(function(a){return a.data.data.images=s.fix_cache(a.data.data.images),e.daily_meal=a.data.data})},fix_cache:function(e){var a,n,t,i;if(null==e)return[];for(a=t=0,i=e.length;i>t;a=++t)if(n=e[a],/main/.test(n))return e[a]=n+"?"+moment(),e;return e}},s.assign(),s.events.assign(),s.uploader(),e.is_edit?s.editing():void 0},e.$inject=a.controllers.form.inject,angular.module(a.name).controller(a.controllers.form.name,e)}).call(this);