(function(){var t,e;e=window.sys.modules.activities,t=function(t,a,n,i,r){var s;return s={assign:function(){return t.is_edit=a.current.name===e.states.edit.name,t.interests=sys.defaults.interests,t.activity={title:"",address:"",description:"",images:[],at:moment(),location:{latitude:33.865,longitude:151.2094},interests:[],price:""}},clear:function(){return jsonMask(t.activity,"title,address,description,at,location/*,interests,price,is_draft")},events:{assign:function(){return t.remove=s.events.remove,t.$on("mapInitialized",s.events.map),t.is_main=s.events.is_main,t.set_as_main=s.events.set_as_main,t.save=s.events.save},save:function(){return t.is_edit?s.events.update():s.events.create()},create:function(){return n.post(e.endpoints.create,s.clear(t.activity)).success(function(t){return console.log(t),a.go("edit_activity",{id:t.data.doc_key})}).error(function(e,a){return console.log(a),400===a?t.error=e.message.split("[")[1].slice(0,-1):void 0})},update:function(){var i;return i=e.endpoints.update.replace(":id",a.params.id),n.put(i,s.clear(t.activity)).success(function(e){return t.activity=e.data}).error(function(e,a){return 400===a?t.error=e.message.split("[")[1].slice(0,-1):void 0})},remove:function(i){var r;return r=e.endpoints.images.remove.replace(":id",a.params.id).replace(":name",t.activity.images[i]),n["delete"](r).then(function(e){return t.activity.images.splice(i,1)})},map:function(e,a){var n,r,s;return r=a,n=function(){var e;return e=new google.maps.Geocoder,e.geocode({address:t.activity.address},function(e,a){var n;return a===google.maps.GeocoderStatus.OK?(n=e[0].geometry.location,r.setCenter(n),r.markers[0].setPosition(n),r.panTo(n),t.activity.location={latitude:n.lat(),longitude:n.lng()}):void 0})},s=null,t.$watch("activity.address",function(){return i.cancel(s),s=i(function(){return n()},2e3)}),t.mark=function(e){return t.activity.location={latitude:e.latLng.lat(),longitude:e.latLng.lng()},r.panTo(e.latLng)}},is_main:function(t){return null!==t.match(/main/)},set_as_main:function(i){var r;return r=e.endpoints.images.main.replace(":id",a.params.id).replace(":name",t.activity.images[i]),n.post(r).then(function(e){return e.data.data=s.fix_cache(e.data.data),t.activity.images=e.data.data})}},uploader:function(){var e;return e=t.uploader=new r({autoUpload:!0,alias:"images[0]"}),e.onSuccessItem=function(e,a,n,i){return a.data=s.fix_cache(a.data),t.activity.images=a.data}},editing:function(){return t.uploader.url=e.endpoints.images.add.replace(":id",a.params.id),n.get(e.endpoints.get.replace(":id",a.params.id)).then(function(e){return e.data.data.images=s.fix_cache(e.data.data.images),t.activity=e.data.data})},fix_cache:function(t){var e,a,n,i;if(null==t)return[];for(e=n=0,i=t.length;i>n;e=++n)if(a=t[e],/main/.test(a))return t[e]=a+"?"+moment(),t;return t}},s.assign(),s.events.assign(),s.uploader(),t.is_edit?s.editing():void 0},t.$inject=e.controllers.form.inject,angular.module(e.name).controller(e.controllers.form.name,t)}).call(this);