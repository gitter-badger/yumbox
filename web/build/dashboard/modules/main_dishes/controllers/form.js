(function(){var e,n;n=window.sys.modules.main_dishes,e=function(e,a,i,t,r){var s;return s={assign:function(){return e.is_edit=a.current.name===n.states.edit.name,e.main_dish={name:"",total:"",contains:"",description:"",calories:"",images:[],at:moment(),price:""}},clear:function(){return jsonMask(e.main_dish,"name,total,calories,remained,contains,description,at/*,price,is_draft")},events:{assign:function(){return e.remove=s.events.remove,e.is_main=s.events.is_main,e.set_as_main=s.events.set_as_main,e.save=s.events.save},save:function(){return e.is_edit?s.events.update():s.events.create()},create:function(){return i.post(n.endpoints.create,s.clear(e.main_dish)).success(function(e){return console.log(e),a.go("edit_main_dish",{id:e.data.doc_key})}).error(function(n,a){return console.log(a),400===a?e.error=n.message.split("[")[1].slice(0,-1):void 0})},update:function(){var t;return t=n.endpoints.update.replace(":id",a.params.id),i.put(t,s.clear(e.main_dish)).success(function(n){return e.main_dish=n.data}).error(function(n,a){return 400===a?e.error=n.message.split("[")[1].slice(0,-1):void 0})},remove:function(r){var s,o;return o=n.endpoints.images.remove.replace(":id",a.params.id).replace(":name",e.main_dish.images[r]),i["delete"](o).then(function(n){return e.main_dish.images.splice(r,1)}),s=null,e.$watch("main_dish.address",function(){return t.cancel(s),s=t(function(){return decode()},2e3)})},is_main:function(e){return null!==e.match(/main/)},set_as_main:function(t){var r;return r=n.endpoints.images.main.replace(":id",a.params.id).replace(":name",e.main_dish.images[t]),i.post(r).then(function(n){return n.data.data=s.fix_cache(n.data.data),e.main_dish.images=n.data.data})}},uploader:function(){var n;return n=e.uploader=new r({autoUpload:!0,alias:"images[0]"}),n.onSuccessItem=function(n,a,i,t){return a.data=s.fix_cache(a.data),e.main_dish.images=a.data}},editing:function(){return e.uploader.url=n.endpoints.images.add.replace(":id",a.params.id),i.get(n.endpoints.get.replace(":id",a.params.id)).then(function(n){return n.data.data.images=s.fix_cache(n.data.data.images),e.main_dish=n.data.data})},fix_cache:function(e){var n,a,i,t;if(null==e)return[];for(n=i=0,t=e.length;t>i;n=++i)if(a=e[n],/main/.test(a))return e[n]=a+"?"+moment(),e;return e}},s.assign(),s.events.assign(),s.uploader(),e.is_edit?s.editing():void 0},e.$inject=n.controllers.form.inject,angular.module(n.name).controller(n.controllers.form.name,e)}).call(this);