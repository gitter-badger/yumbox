(function(){var e,n;n=window.sys.modules.side_dishes,e=function(e,a,i,t,s){var r;return r={assign:function(){return e.is_edit=a.current.name===n.states.edit.name,e.interests=sys.defaults.interests,e.side_dish={name:"",images:[]}},clear:function(){return jsonMask(e.side_dish,"name,at/*,is_draft")},events:{assign:function(){return e.remove=r.events.remove,e.is_main=r.events.is_main,e.set_as_main=r.events.set_as_main,e.save=r.events.save},save:function(){return e.is_edit?r.events.update():r.events.create()},create:function(){return i.post(n.endpoints.create,r.clear(e.side_dish)).success(function(e){return console.log(e),a.go("edit_side_dish",{id:e.data.doc_key})}).error(function(n,a){return console.log(a),400===a?e.error=n.message.split("[")[1].slice(0,-1):void 0})},update:function(){var t;return t=n.endpoints.update.replace(":id",a.params.id),i.put(t,r.clear(e.side_dish)).success(function(n){return e.side_dish=n.data}).error(function(n,a){return 400===a?e.error=n.message.split("[")[1].slice(0,-1):void 0})},remove:function(t){var s;return s=n.endpoints.images.remove.replace(":id",a.params.id).replace(":name",e.side_dish.images[t]),i["delete"](s).then(function(n){return e.side_dish.images.splice(t,1)})},is_main:function(e){return null!==e.match(/main/)},set_as_main:function(t){var s;return s=n.endpoints.images.main.replace(":id",a.params.id).replace(":name",e.side_dish.images[t]),i.post(s).then(function(n){return n.data.data=r.fix_cache(n.data.data),e.side_dish.images=n.data.data})}},uploader:function(){var n;return n=e.uploader=new s({autoUpload:!0,alias:"images[0]"}),n.onSuccessItem=function(n,a,i,t){return a.data=r.fix_cache(a.data),e.side_dish.images=a.data}},editing:function(){return e.uploader.url=n.endpoints.images.add.replace(":id",a.params.id),i.get(n.endpoints.get.replace(":id",a.params.id)).then(function(n){return n.data.data.images=r.fix_cache(n.data.data.images),e.side_dish=n.data.data})},fix_cache:function(e){var n,a,i,t;if(null==e)return[];for(n=i=0,t=e.length;t>i;n=++i)if(a=e[n],/main/.test(a))return e[n]=a+"?"+moment(),e;return e}},r.assign(),r.events.assign(),r.uploader(),e.is_edit?r.editing():void 0},e.$inject=n.controllers.form.inject,angular.module(n.name).controller(n.controllers.form.name,e)}).call(this);